<div class="q-item-container">
  <h3 class="s-q-item__title">{{title}}</h3>
  <Header subtitle='{{subtitle}}' isIntermediate='{{isIntermediate}}' updatedDate='{{updatedDate}}' />
  <div class="q-election-parties {{thresholdOffset}}">
    <Threshold threshold='{{threshold}}' maxResult='{{maxResult}}' />
    {{#each partyItems as party}}
      <ElectionItem item='{{party}}' maxResult='{{maxResult}}' />
    {{/each}}
  </div>
  {{#if otherPartiesItem}}
    <div class="q-election-others">
      <ElectionItem item='{{otherPartiesItem}}' maxResult='{{maxResult}}' />
    </div>
  {{/if}}
  <Footer sources='{{sources}}' notes='{{notes}}' />
</div>

<script>
  import Header from './Header.html';
  import Threshold from './Threshold.html';
  import ElectionItem from './ElectionItem.html';
  import Footer from './Footer.html';

  export default {
    computed: {
      sortedParties: (parties) => {
        return parties.sort(function(partyA, partyB) {
          if ((partyA.percentage === undefined && partyB.percentage === undefined) || (partyA.percentage === partyB.percentage)) {
            return 0;
          }
          if ((partyA.percentage === undefined && partyB.percentage !== undefined) || (partyA.percentage < partyB.percentage)) {
            return 1;
          }
          return -1;
        })
      },
      maxResult: (sortedParties) => {
        let maxResult = 0;
        // if there are already any votes the first party 
        // of sorted list of party has max percentage
        if (sortedParties[0] && sortedParties[0].percentage) {
          maxResult = sortedParties[0].percentage;
        }
        return maxResult;
      },
      enhancedParties: (sortedParties, maxResult) => {
        sortedParties.forEach(party => {
          // define width of each party's bar
          let width = '1px';
          if (maxResult > 0 && party.percentage && party.percentage > 0) {
            let widthPercentage = party.percentage * 100 / maxResult;
            width = widthPercentage + '%';
          }
          party.width = width;
          
          // define color of each party's bar either via class attribute or color code
          let colorStyle = '';
          let colorClass = '';
          if (party.color) {
            if (party.color.classAttribute) {
              colorClass = party.color.classAttribute;
            } else {
              colorStyle = 'background-color: ' + party.color.colorCode + ';';
            }
          }
          party.colorClass = colorClass;
          party.colorStyle = colorStyle;
          
          // calculate trend out of previous and current result and use it 
          // to calculate rotation degree of trend arrow
          if (party.previous && party.previous > 0) {
            party.trend = (party.percentage - party.previous).toFixed(1);
          } else {
            party.trend = party.percentage.toFixed(1);
          }
          
          let trendDegree = (Math.min(Math.abs(party.trend),5) * 90) / 5;
          if (party.trend > 0) {
            trendDegree = -trendDegree;
          }
          party.trendDegree = trendDegree;
        })
        
        let othersIndex = sortedParties.findIndex(party => {
          let othersPattern = /((.*(A|a)ndere.*)|(.*(S|s)onstig.*))/; 
          return othersPattern.test(party.name);
        })
        if (othersIndex >= 0) {
          let others = sortedParties.splice(othersIndex, 1);
          return {
            parties: sortedParties,
            others: others[0]
          }
        } else {
          return {
            parties: sortedParties
          }
        }
      },
      partyItems: (enhancedParties) => {
        return enhancedParties.parties
      },
      otherPartiesItem : (enhancedParties) => {
        return enhancedParties.others;
      },
      thresholdOffset: (threshold, maxResult) => {
        if (threshold !== undefined && threshold > 0 && maxResult > 0) {
          return 'q-election-threshold-offset';
        }
        else '';
      }
    },

    components: {
      Header,
      Threshold,
      ElectionItem,
      Footer
    }
  };
</script>
